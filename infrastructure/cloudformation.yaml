AWSTemplateFormatVersion: 2010-09-09
Description: Complete Q Business Public Sector Application with S3 theme assets,
  Secrets Manager, and customized web experience

Parameters:
  QBusinessApplicationName:
    Description: The name of the Q Business Application
    Type: String
    Default: GovernmentAIAssistant
    AllowedPattern: ^[a-zA-Z0-9][a-zA-Z0-9_-]*$
    ConstraintDescription: Must contain only alphanumeric characters, hyphens, and underscores

  SessionDurationMinutes:
    Description: Session duration in minutes for anonymous users
    Type: Number
    Default: 15
    MinValue: 15
    MaxValue: 60

  ThemeBucketName:
    Description: S3 bucket name for theme assets (must be globally unique)
    Type: String
    Default: qbusiness-theme
    AllowedPattern: ^[a-z0-9][a-z0-9-]*[a-z0-9]$
    ConstraintDescription: Must be a valid S3 bucket name

  GitHubRepository:
    Description: GitHub repository URL (optional - for automatic deployment)
    Type: String
    Default: ""

  GitHubAccessToken:
    Description: GitHub personal access token (optional - for automatic deployment)
    Type: String
    Default: ""
    NoEcho: true

  GitHubBranch:
    Description: GitHub branch to deploy (optional - defaults to main)
    Type: String
    Default: main

  DeveloperOrigins:
    Description: Optional comma-delimited list of developer origins for Q Business web experience (e.g., http://localhost:3000,http://localhost:8080)
    Type: CommaDelimitedList
    Default: "http://localhost:3000"

Conditions:
  HasGitHubRepo: !Not
    - !Equals
      - !Ref GitHubRepository
      - ""
  HasGitHubToken: !Not
    - !Equals
      - !Ref GitHubAccessToken
      - ""

Resources:
  # IAM Role for Q Business Web Experience
  QBusinessWebExperienceServiceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: application.qbusiness.amazonaws.com
            Action:
              - sts:AssumeRole
              - sts:SetContext
            Condition:
              StringEquals:
                aws:SourceAccount: !Sub ${AWS::AccountId}
              ArnLike:
                aws:SourceArn: !Sub arn:${AWS::Partition}:qbusiness:${AWS::Region}:${AWS::AccountId}:application/${QBusinessApp.ApplicationId}
      Path: /service-role/
      ManagedPolicyArns:
        - !Ref QBusinessWebExperienceServiceManagedPolicy

  # Managed Policy for Web Experience
  QBusinessWebExperienceServiceManagedPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: Q Web Experience Managed Policy
      Path: /service-role/
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - qbusiness:Chat
              - qbusiness:ChatSync
              - qbusiness:PutFeedback
              - qbusiness:GetApplication
              - qbusiness:GetChatControlsConfiguration
            Resource: !Sub arn:${AWS::Partition}:qbusiness:${AWS::Region}:${AWS::AccountId}:application/${QBusinessApp.ApplicationId}

  # Q Business Application with Anonymous access
  QBusinessApp:
    Type: AWS::QBusiness::Application
    Properties:
      DisplayName: !Ref QBusinessApplicationName
      Description: Q Business Application with Anonymous access
      IdentityType: ANONYMOUS
      RoleArn: !Sub arn:${AWS::Partition}:iam::${AWS::AccountId}:role/aws-service-role/qbusiness.amazonaws.com/AWSServiceRoleForQBusiness

  # Q Business Index
  QBusinessIndex:
    Type: AWS::QBusiness::Index
    Properties:
      ApplicationId: !GetAtt QBusinessApp.ApplicationId
      DisplayName: qbusiness-index
      Type: STARTER

  # Q Business Retriever
  QBusinessRetriver:
    Type: AWS::QBusiness::Retriever
    Properties:
      ApplicationId: !GetAtt QBusinessApp.ApplicationId
      Configuration:
        NativeIndexConfiguration:
          IndexId: !GetAtt QBusinessIndex.IndexId
      DisplayName: qbusiness-retriever
      Type: NATIVE_INDEX

  # S3 Bucket for Access Logs
  #checkov:skip=CKV_AWS_18:Access logs bucket cannot log to itself
  AccessLogsBucket:
    Type: AWS::S3::Bucket
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W35
            reason: "Access logging not required for access logs bucket - would create circular logging"
      checkov:
        skip:
          - id: CKV_AWS_18
            comment: "This is an access logs bucket and does not need its own access logging."
    Properties:
      BucketName: !Sub
        - ${BucketName}-access-logs-${StackName}-${UniqueId}
        - BucketName: !Ref ThemeBucketName
          StackName: !Ref AWS::StackName
          UniqueId: !Select
            - 0
            - !Split
              - "-"
              - !Select
                - 2
                - !Split
                  - /
                  - !Ref AWS::StackId
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldLogs
            Status: Enabled
            ExpirationInDays: 30

  # S3 Bucket Policy for Access Logs - SSL Only
  AccessLogsBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Metadata:
      cdk_nag:
        rules_to_suppress:
          - id: AwsSolutions-IAM5
            reason: "Wildcard permissions required for S3 SSL-only deny policy"
    Properties:
      Bucket: !Ref AccessLogsBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: DenyInsecureConnections
            Effect: Deny
            Principal: "*"
            Action: s3:*
            Resource:
              - !Sub ${AccessLogsBucket.Arn}
              - !Sub ${AccessLogsBucket.Arn}/*
            Condition:
              Bool:
                aws:SecureTransport: "false"

  # S3 Bucket for Theme Assets
  #checkov:skip=CKV_AWS_S10:Bucket policy applied dynamically by upload script with Referer condition
  ThemeAssetsBucket:
    Type: AWS::S3::Bucket
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W35
            reason: "Access logging not required for theme assets bucket - contains only public CSS/images"
          - id: W51
            reason: "Bucket policy applied dynamically by upload script with SSL enforcement and Referer conditions"
      cdk_nag:
        rules_to_suppress:
          - id: AwsSolutions-S2
            reason: "Q Business requires controlled public access for theming per AWS documentation"
          - id: AwsSolutions-S10
            reason: "Bucket policy applied dynamically by upload script with SSL enforcement"
    Properties:
      BucketName: !Sub
        - ${BucketName}-${StackName}-${UniqueId}
        - BucketName: !Ref ThemeBucketName
          StackName: !Ref AWS::StackName
          UniqueId: !Select
            - 0
            - !Split
              - "-"
              - !Select
                - 2
                - !Split
                  - /
                  - !Ref AWS::StackId
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerEnforced
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      VersioningConfiguration:
        Status: Enabled
      LoggingConfiguration:
        DestinationBucketName: !Ref AccessLogsBucket
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldAssets
            Status: Enabled
            ExpirationInDays: 90

  # KMS Key for Secrets Manager encryption
  SecretsManagerKMSKey:
    Type: AWS::KMS::Key
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: F19
            reason: "KMS key rotation not required for Q Business configuration secrets with static values"
      cdk_nag:
        rules_to_suppress:
          - id: AwsSolutions-KMS5
            reason: "KMS key rotation not required for Q Business configuration secrets with static values"
      checkov:
        skip:
          - id: CKV_AWS_7
            comment: "KMS key rotation not required for Q Business configuration secrets with static values."
    Properties:
      Description: KMS key for Q Business Secrets Manager encryption
      KeyPolicy:
        Version: '2012-10-17'
        Statement:
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Principal:
              AWS: !Sub arn:${AWS::Partition}:iam::${AWS::AccountId}:root
            Action: kms:*
            Resource: '*'
          - Sid: Allow Secrets Manager
            Effect: Allow
            Principal:
              Service: secretsmanager.amazonaws.com
            Action:
              - kms:Decrypt
              - kms:GenerateDataKey
            Resource: '*'

  # KMS Key Alias
  SecretsManagerKMSKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub alias/${AWS::StackName}-secrets-manager
      TargetKeyId: !Ref SecretsManagerKMSKey

  # Secrets Manager Secret for Q Business Configuration
  QBusinessConfigSecret:
    Type: AWS::SecretsManager::Secret
    Metadata:
      cdk_nag:
        rules_to_suppress:
          - id: AwsSolutions-SMG4
            reason: "Q Business configuration secret contains static values and does not require automatic rotation"
    Properties:
      Name: qbusiness-webexperience-config
      Description: Q Business Application and Web Experience IDs for Amplify app
      KmsKeyId: !Ref SecretsManagerKMSKey
      SecretString: !Sub
        - '{"QBUSINESS_APP_ID": "${QBusinessApp.ApplicationId}",
          "QBUSINESS_WEB_EXP_ID": "${WebExperienceId}"}'
        - WebExperienceId: !Select
            - 1
            - !Split
              - "|"
              - !Ref QBusinessWebExperience

  # Q Business Web Experience with Government Customization
  QBusinessWebExperience:
    Type: AWS::QBusiness::WebExperience
    DependsOn:
      - ThemeAssetsBucket
    Properties:
      ApplicationId: !GetAtt QBusinessApp.ApplicationId
      RoleArn: !GetAtt QBusinessWebExperienceServiceRole.Arn
      Title: Demo Government AI Assistant
      Subtitle: Providing secure information access for public sector agencies
      WelcomeMessage: Welcome to your secure AI assistant. I can help you find
        information from approved government resources. How may I assist you
        today?
      SamplePromptsControlMode: ENABLED
      Origins: !Ref DeveloperOrigins

  # IAM Service Role for Amplify
  AmplifyServiceRole:
    Type: AWS::IAM::Role
    Metadata:
      cdk_nag:
        rules_to_suppress:
          - id: AwsSolutions-IAM5
            reason: "Wildcard permissions required for Amplify log group access pattern"
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: amplify.amazonaws.com
            Action: sts:AssumeRole
            Condition:
              StringEquals:
                aws:SourceAccount: !Ref AWS::AccountId
      Policies:
        - PolicyName: CloudWatchLogsAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:CreateLogGroup
                  - logs:DescribeLogGroups
                  - logs:PutLogEvents
                Resource: !Sub arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/amplify/*

  # IAM Role for Amplify Compute
  AmplifyComputeRole:
    Type: AWS::IAM::Role
    Metadata:
      cdk_nag:
        rules_to_suppress:
          - id: AwsSolutions-IAM5
            reason: "Wildcard permissions required for Amplify log management and dynamic log streams"
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: amplify.amazonaws.com
            Action: sts:AssumeRole
            Condition:
              StringEquals:
                aws:SourceAccount: !Ref AWS::AccountId

      Policies:
        - PolicyName: AmplifyComputePolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Sid: PushLogs
                Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/amplify/*:log-stream:*
              - Sid: CreateLogGroup
                Effect: Allow
                Action: logs:CreateLogGroup
                Resource: !Sub arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/amplify/*
              - Sid: DescribeLogGroups
                Effect: Allow
                Action: logs:DescribeLogGroups
                Resource: !Sub arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:*
              - Effect: Allow
                Action: secretsmanager:GetSecretValue # pragma: allowlist secret
                Resource: !Ref QBusinessConfigSecret
              - Effect: Allow
                Action:
                  - kms:Decrypt
                  - kms:GenerateDataKey
                Resource: !GetAtt SecretsManagerKMSKey.Arn
              - Effect: Allow
                Action: qbusiness:CreateAnonymousWebExperienceUrl
                Resource:
                  - !Sub arn:${AWS::Partition}:qbusiness:${AWS::Region}:${AWS::AccountId}:application/${QBusinessApp.ApplicationId}
                  - !Sub
                    - arn:${AWS::Partition}:qbusiness:${AWS::Region}:${AWS::AccountId}:application/${QBusinessApp.ApplicationId}/web-experience/${WebExperienceId}
                    - WebExperienceId: !Select
                        - 1
                        - !Split
                          - "|"
                          - !Ref QBusinessWebExperience

  # Amplify Application
  AmplifyApp:
    Type: AWS::Amplify::App
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: F41
            reason: "GitHub AccessToken parameter follows AWS Amplify CloudFormation best practices per https://docs.aws.amazon.com/amplify/latest/userguide/setting-up-GitHub-access.html#setting-up-github-app-cloudformation"
    DependsOn:
      - QBusinessConfigSecret
    Properties:
      Name: !Sub ${AWS::StackName}-qbusiness-app
      Description: Q Business Anonymous Web Experience with Custom Theming
      Platform: WEB_COMPUTE
      IAMServiceRole: !GetAtt AmplifyServiceRole.Arn
      ComputeRoleArn: !GetAtt AmplifyComputeRole.Arn
      Repository: !If
        - HasGitHubRepo
        - !Ref GitHubRepository
        - !Ref AWS::NoValue
      AccessToken: !If
        - HasGitHubToken
        - !Ref GitHubAccessToken
        - !Ref AWS::NoValue
      AutoBranchCreationConfig:
        EnableAutoBranchCreation: true
        EnableAutoBuild: true
        AutoBranchCreationPatterns:
          - !Ref GitHubBranch
      BuildSpec: !Sub |
        version: 1
        frontend:
          phases:
            preBuild:
              commands:
                - nvm install 22
                - nvm use 22
                - node --version
                - npm install
            build:
              commands:
                - ./scripts/build.sh
          artifacts:
            baseDirectory: .amplify-hosting
            files:
              - '**/*'
      EnvironmentVariables:
        - Name: SECRET_NAME
          Value: !Ref QBusinessConfigSecret
        - Name: REGION
          Value: !Ref AWS::Region
        - Name: SESSION_DURATION_MINUTES
          Value: !Ref SessionDurationMinutes
      Tags:
        - Key: Project
          Value: QBusinessPublicSector
        - Key: Environment
          Value: Production

  # CloudWatch Log Group for Amplify
  AmplifyLogGroup:
    Type: AWS::Logs::LogGroup
    DependsOn: 
      - AmplifyLogGroupKMSKey
      - AmplifyLogGroupKMSKeyAlias
    Properties:
      LogGroupName: !Sub /aws/amplify/${AmplifyApp.AppId}
      RetentionInDays: 14
      KmsKeyId: !GetAtt AmplifyLogGroupKMSKey.Arn

  # KMS Key for Amplify Log Group encryption
  AmplifyLogGroupKMSKey:
    Type: AWS::KMS::Key
    Properties:
      Description: KMS Key for Amplify Log Group encryption
      EnableKeyRotation: true
      KeyPolicy:
        Version: "2012-10-17"
        Statement:
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Principal:
              AWS: !Sub arn:${AWS::Partition}:iam::${AWS::AccountId}:root
            Action: kms:*
            Resource: "*"
          - Sid: Allow CloudWatch Logs
            Effect: Allow
            Principal:
              Service: !Sub logs.${AWS::Region}.amazonaws.com
            Action:
              - kms:Encrypt
              - kms:Decrypt
              - kms:ReEncrypt*
              - kms:GenerateDataKey*
              - kms:DescribeKey
            Resource: "*"
            Condition:
              ArnEquals:
                kms:EncryptionContext:aws:logs:arn: !Sub arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/amplify/${AmplifyApp.AppId}

  AmplifyLogGroupKMSKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub alias/${AWS::StackName}-amplify-logs
      TargetKeyId: !Ref AmplifyLogGroupKMSKey

  # AWS WAF WebACL for Amplify
  AmplifyWebACL:
    Type: AWS::WAFv2::WebACL
    Properties:
      Name: !Sub ${AWS::StackName}-amplify-waf
      Description: WAF for Amplify application protection
      Scope: REGIONAL
      DefaultAction:
        Allow: {}
      Rules:
        - Name: AWSManagedRulesCommonRuleSet
          Priority: 1
          OverrideAction:
            None: {}
          Statement:
            ManagedRuleGroupStatement:
              VendorName: AWS
              Name: AWSManagedRulesCommonRuleSet
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: CommonRuleSetMetric
        - Name: AWSManagedRulesKnownBadInputsRuleSet
          Priority: 2
          OverrideAction:
            None: {}
          Statement:
            ManagedRuleGroupStatement:
              VendorName: AWS
              Name: AWSManagedRulesKnownBadInputsRuleSet
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: KnownBadInputsRuleSetMetric
      VisibilityConfig:
        SampledRequestsEnabled: true
        CloudWatchMetricsEnabled: true
        MetricName: !Sub ${AWS::StackName}-amplify-waf

  # AWS WAF WebACL Association with Amplify
  AmplifyWAFAssociation:
    Type: AWS::WAFv2::WebACLAssociation
    DependsOn: 
      - AmplifyWebACL
      - AmplifyApp
    Properties:
      ResourceArn: !GetAtt AmplifyApp.Arn
      WebACLArn: !GetAtt AmplifyWebACL.Arn

  AmplifyBranch:
    Type: AWS::Amplify::Branch
    Condition: HasGitHubRepo
    Properties:
      AppId: !GetAtt AmplifyApp.AppId
      BranchName: !Ref GitHubBranch
      Stage: PRODUCTION
      EnableAutoBuild: true
      EnablePullRequestPreview: false

Outputs:
  QBusinessApplicationId:
    Description: The ID of the QBusiness application
    Value: !GetAtt QBusinessApp.ApplicationId
    Export:
      Name: !Sub ${AWS::StackName}-QBusinessAppId

  QBusinessWebExperienceId:
    Description: The ID of the QBusiness web experience
    Value: !Ref QBusinessWebExperience
    Export:
      Name: !Sub ${AWS::StackName}-QBusinessWebExpId

  QBusinessDefaultEndpoint:
    Description: Default endpoint URL for the Q Business web experience
    Value: !GetAtt QBusinessWebExperience.DefaultEndpoint
    Export:
      Name: !Sub ${AWS::StackName}-QBusinessEndpoint

  ThemeBucketName:
    Description: S3 bucket name for theme assets
    Value: !Ref ThemeAssetsBucket
    Export:
      Name: !Sub ${AWS::StackName}-ThemeBucket

  SecretsManagerSecretName:
    Description: Name of the Secrets Manager secret containing Q Business configuration
    Value: qbusiness-webexperience-config
    Export:
      Name: !Sub ${AWS::StackName}-SecretName

  AmplifyComputeRoleArn:
    Description: ARN of the IAM role for Amplify Compute
    Value: !GetAtt AmplifyComputeRole.Arn
    Export:
      Name: !Sub ${AWS::StackName}-AmplifyRoleArn

  AmplifyAppId:
    Description: Amplify App ID
    Value: !GetAtt AmplifyApp.AppId
    Export:
      Name: !Sub ${AWS::StackName}-AmplifyAppId

  AmplifyAppArn:
    Description: Amplify App ARN
    Value: !GetAtt AmplifyApp.Arn
    Export:
      Name: !Sub ${AWS::StackName}-AmplifyAppArn

  AmplifyDefaultDomain:
    Description: Amplify App Default Domain URL (add this to Q Business allowed websites)
    Value: !Sub https://${GitHubBranch}.${AmplifyApp.AppId}.amplifyapp.com
    Condition: HasGitHubRepo
    Export:
      Name: !Sub ${AWS::StackName}-AmplifyDomain

  WAFWebACLArn:
    Description: WAF WebACL ARN for Amplify association
    Value: !GetAtt AmplifyWebACL.Arn
    Export:
      Name: !Sub ${AWS::StackName}-WAFWebACLArn
